@page "/products/create"
@using Microsoft.EntityFrameworkCore
@using MyMedia.GestaoLoja.Entities
@using MyMedia.GestaoLoja.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Criar Produto</PageTitle>

<h1>Criar Novo Produto</h1>

<hr />
<div class="row">
    <div class="col-md-6">
        <EditForm method="post" Model="Product" OnValidSubmit="AddProduct" FormName="create" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            @* Nome *@
            <div class="mb-3">
                <label for="name" class="form-label">Nome</label>
                <InputText id="name" @bind-Value="Product.Name" class="form-control" />
                <ValidationMessage For="() => Product.Name" class="text-danger" />
            </div>

            @* Descrição *@
            <div class="mb-3">
                <label for="description" class="form-label">Descrição</label>
                <InputTextArea id="description" @bind-Value="Product.Description" class="form-control" />
                <ValidationMessage For="() => Product.Description" class="text-danger" />
            </div>

            @* Preço Base *@
            <div class="mb-3">
                <label for="price" class="form-label fw-bold">Preço de Custo (€)</label>
                <InputNumber id="price" @bind-Value="Product.Price" class="form-control" />
                <ValidationMessage For="() => Product.Price" class="text-danger" />
            </div>

            @* Stock *@
            <div class="mb-3">
                <label for="stock" class="form-label">Stock</label>
                <InputNumber id="stock" @bind-Value="Product.Stock" class="form-control" />
                <ValidationMessage For="() => Product.Stock" class="text-danger" />
            </div>

            @* Dropdown Categoria *@
            <div class="mb-3">
                <label for="category" class="form-label">Categoria</label>
                <InputSelect id="category" @bind-Value="Product.CategoryId" class="form-control">
                    <option value="">-- Selecione --</option>
                    @foreach (var cat in Categories)
                    {
                        <option value="@cat.Id">@cat.Name</option>
                    }
                </InputSelect>
            </div>

            @* Dropdown Modo Disponibilização *@
            <div class="mb-3">
                <label for="mode" class="form-label">Modo Disponibilização</label>
                <InputSelect id="mode" @bind-Value="Product.AvailabilityModeId" class="form-control">
                    <option value="">-- Selecione --</option>
                    @foreach (var mode in AvailabilityModes)
                    {
                        <option value="@mode.Id">@mode.Name</option>
                    }
                </InputSelect>
            </div>

            @* UPLOAD DE IMAGEM *@
            <div class="mb-3">
                <label class="form-label">Imagem do Produto</label>
                <InputFile OnChange="LoadFiles" class="form-control" accept=".png,.jpg,.jpeg" />
                @if (imagePreview != null)
                {
                    <div class="mt-2">
                        <img src="@imagePreview" style="max-width: 200px; border: 1px solid #ccc;" />
                    </div>
                }
            </div>

            @* Checkbox Ativo *@
            <div class="mb-3 form-check">
                <label class="form-check-label">
                    <InputCheckbox @bind-Value="Product.IsActive" class="form-check-input" />
                    Visível ao Público?
                </label>
            </div>

            <button type="submit" class="btn btn-primary">Guardar Produto</button>
        </EditForm>
    </div>
</div>

<div>
    <a href="/products">Voltar à Lista</a>
</div>

@code {
    [SupplyParameterFromForm]
    private Product Product { get; set; } = new();

    private string? MensagemLucro;

    // Listas para as Dropdowns
    private List<Category> Categories = new();
    private List<AvailabilityMode> AvailabilityModes = new();

    // Variáveis para a Imagem
    private string? imagePreview;
    private long maxFileSize = 1024 * 1024 * 5; // 5MB

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Categories = await context.Categories.ToListAsync();
        AvailabilityModes = await context.AvailabilityModes.ToListAsync();
    }

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        var file = e.File;
        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            // Guarda os bytes no Produto (para a BD)
            Product.Image = ms.ToArray();
            Product.ImageMimeType = file.ContentType;

            // Cria uma preview para mostrar no ecrã agora
            var base64 = Convert.ToBase64String(Product.Image);
            imagePreview = $"data:{file.ContentType};base64,{base64}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar imagem: {ex.Message}");
        }
    }

    private async Task AddProduct()
    {
        using var context = DbFactory.CreateDbContext();

        var settings = await context.CompanySettings.FirstOrDefaultAsync();

        
        decimal margem = settings?.ProfitMargin ?? 0.50m;

        decimal precoBase = Product.Price;

        Product.Price = Product.Price + (Product.Price * margem);

        context.Products.Add(Product);
        await context.SaveChangesAsync();
        Navigation.NavigateTo("/products");
    }
}