@page "/products/edit"
@using Microsoft.EntityFrameworkCore
@using MyMedia.GestaoLoja.Entities
@using MyMedia.GestaoLoja.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Editar Produto</PageTitle>

<h1>Editar Produto</h1>

<hr />
@if (Product is null)
{
    <p><em>A carregar...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <EditForm method="post" Model="Product" OnValidSubmit="UpdateProduct" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                @* Campo Oculto para o ID *@
                <input type="hidden" name="Product.Id" value="@Product.Id" />

                @* Nome *@
                <div class="mb-3">
                    <label for="name" class="form-label">Nome</label>
                    <InputText id="name" @bind-Value="Product.Name" class="form-control" />
                    <ValidationMessage For="() => Product.Name" class="text-danger" />
                </div>

                @* Descrição *@
                <div class="mb-3">
                    <label for="description" class="form-label">Descrição</label>
                    <InputTextArea id="description" @bind-Value="Product.Description" class="form-control" />
                    <ValidationMessage For="() => Product.Description" class="text-danger" />
                </div>

                @* Preço Base *@
                <div class="mb-3">
                    <label for="price" class="form-label fw-bold">Preço de Custo (€)</label>
                    <p class="text-muted small">
                        <br />Margem atual estimada: <strong>@((MargemAtual * 100).ToString("0"))%</strong>
                    </p>
                    <InputNumber id="price" @bind-Value="Product.Price" class="form-control" />
                    <ValidationMessage For="() => Product.Price" class="text-danger" />
                </div>

                @* Stock *@
                <div class="mb-3">
                    <label for="stock" class="form-label">Stock</label>
                    <InputNumber id="stock" @bind-Value="Product.Stock" class="form-control" />
                    <ValidationMessage For="() => Product.Stock" class="text-danger" />
                </div>

                @* Dropdown Categoria *@
                <div class="mb-3">
                    <label for="category" class="form-label">Categoria</label>
                    <InputSelect id="category" @bind-Value="Product.CategoryId" class="form-control">
                        <option value="">-- Selecione --</option>
                        @foreach (var cat in Categories)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </InputSelect>
                </div>

                @* Dropdown Modo Disponibilização *@
                <div class="mb-3">
                    <label for="mode" class="form-label">Modo Disponibilização</label>
                    <InputSelect id="mode" @bind-Value="Product.AvailabilityModeId" class="form-control">
                        <option value="">-- Selecione --</option>
                        @foreach (var mode in AvailabilityModes)
                        {
                            <option value="@mode.Id">@mode.Name</option>
                        }
                    </InputSelect>
                </div>

                @* IMAGEM (Visualização + Edição) *@
                <div class="mb-3">
                    <label class="form-label">Imagem Atual</label>
                    @if (imagePreview != null)
                    {
                        <div class="mb-2">
                            <img src="@imagePreview" style="max-width: 200px; border: 1px solid #ccc;" />
                        </div>
                    }
                    <label class="form-label">Alterar Imagem (Opcional)</label>
                    <InputFile OnChange="LoadFiles" class="form-control" accept=".png,.jpg,.jpeg" />
                </div>

                @* Checkbox Ativo *@
                <div class="mb-3 form-check">
                    <label class="form-check-label">
                        <InputCheckbox @bind-Value="Product.IsActive" class="form-check-input" />
                        Visível ao Público?
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">Guardar Alterações</button>
            </EditForm>
        </div>
    </div>
}

<div>
    <a href="/products">Voltar à Lista</a>
</div>

@code {
    [SupplyParameterFromQuery]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    public Product? Product { get; set; }

    private List<Category> Categories = new();
    private List<AvailabilityMode> AvailabilityModes = new();

    private decimal MargemAtual = 0.50m; // Valor por defeito para visualização
    private string? imagePreview;
    private long maxFileSize = 1024 * 1024 * 5;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        Categories = await context.Categories.ToListAsync();
        AvailabilityModes = await context.AvailabilityModes.ToListAsync();

        var settings = await context.CompanySettings.FirstOrDefaultAsync();
        MargemAtual = settings?.ProfitMargin ?? 0.50m;

        Product ??= await context.Products.FirstOrDefaultAsync(m => m.Id == Id);

        if (Product is null)
        {
            Navigation.NavigateTo("notfound");
        }
        else
        {
            Product.Price = Product.Price / (1 + MargemAtual);
        }
    }

    // Lógica da Imagem
    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        var file = e.File;
        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            if (Product != null)
            {
                Product.Image = ms.ToArray();
                Product.ImageMimeType = file.ContentType;
                var base64 = Convert.ToBase64String(Product.Image);
                imagePreview = $"data:{file.ContentType};base64,{base64}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro imagem: {ex.Message}");
        }
    }

    private async Task UpdateProduct()
    {
        using var context = DbFactory.CreateDbContext();

        context.Attach(Product!).State = EntityState.Modified;

      
        var settings = await context.CompanySettings.FirstOrDefaultAsync();
        decimal margem = settings?.ProfitMargin ?? 0.50m;

     
        Product!.Price = Product.Price + (Product.Price * margem);

    

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!ProductExists(Product!.Id))
            {
                Navigation.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        Navigation.NavigateTo("/products");
    }

    private bool ProductExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Products.Any(e => e.Id == id);
    }
}